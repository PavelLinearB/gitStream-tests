# -*- mode: yaml -*-
# This example configuration for provides basic automations to get started with gitStream.
# View the gitStream quickstart for more examples: https://docs.gitstream.cm/quick-start/
manifest:
  version: 1.0

automations:
  # Track usage of AI coding assistants like Cursor and Copilot
  # Based on https://docs.gitstream.cm/integrations/linearb/#track-the-impact-of-generative-ai-initiatives
  comment_ai_assistance_prompt:
    # Post a comment for all PRs to prompt the PR author to indicate whether they used AI to assist coding in this PR
    if:
      - true
    run:
      - action: add-comment@v1
        args:
          comment: |
            Please mark whether you used AI to assist coding in this PR:

            - [ ] Cursor
            - [ ] Tabnine
            - [ ] Copilot
            - [ ] JetBrains AI
            - [ ] IntelliCode
            - [ ] ChatGPT
            - [ ] Other
            - [ ] Not AI-assisted

  # If the PR author has indicated that they used AI to assist coding in this PR, apply a label indicating this
  # Based on https://docs.gitstream.cm/integrations/linearb/#track-the-impact-of-generative-ai-initiatives
  label_ai_pr_cursor:
    if:
      - {{ pr.comments | filter(attr='commenter', term='gitstream-cm') | filter(attr='content', regex=r/\- \[x\] Cursor/) | some }}
    run:
      - action: add-labels@v1
        args:
          labels: ['🤖 ai-assisted', '🤖 ai-cursor']
          color: {{ colors.purple }}

  # If the PR author has indicated that they used AI to assist coding in this PR, apply a label indicating this
  # Based on https://docs.gitstream.cm/integrations/linearb/#track-the-impact-of-generative-ai-initiatives
  label_ai_pr_tabnine:
    if:
      - {{ pr.comments | filter(attr='commenter', term='gitstream-cm') | filter(attr='content', regex=r/\- \[x\] Tabnine/) | some }}
    run:
      - action: add-labels@v1
        args:
          labels: ['🤖 ai-assisted', '🤖 ai-tabnine']
          color: {{ colors.purple }}

  # If the PR author has indicated that they used AI to assist coding in this PR, apply a label indicating this
  # Based on https://docs.gitstream.cm/integrations/linearb/#track-the-impact-of-generative-ai-initiatives
  label_ai_pr_copilot:
    if:
      - {{ pr.comments | filter(attr='commenter', term='gitstream-cm') | filter(attr='content', regex=r/\- \[x\] Copilot/) | some }}
    run:
      - action: add-labels@v1
        args:
          labels: ['🤖 ai-assisted', '🤖 ai-copilot']
          color: {{ colors.purple }}

  # If the PR author has indicated that they used AI to assist coding in this PR, apply a label indicating this
  # Based on https://docs.gitstream.cm/integrations/linearb/#track-the-impact-of-generative-ai-initiatives
  label_ai_pr_jetbrains:
    if:
      - {{ pr.comments | filter(attr='commenter', term='gitstream-cm') | filter(attr='content', regex=r/\- \[x\] JetBrains/) | some }}
    run:
      - action: add-labels@v1
        args:
          labels: ['🤖 ai-assisted', '🤖 ai-jetbrains']
          color: {{ colors.purple }}

  # If the PR author has indicated that they used AI to assist coding in this PR, apply a label indicating this
  # Based on https://docs.gitstream.cm/integrations/linearb/#track-the-impact-of-generative-ai-initiatives
  label_ai_pr_intellicode:
    if:
      - {{ pr.comments | filter(attr='commenter', term='gitstream-cm') | filter(attr='content', regex=r/\- \[x\] IntelliCode/) | some }}
    run:
      - action: add-labels@v1
        args:
          labels: ['🤖 ai-assisted', '🤖 ai-intellicode']
          color: {{ colors.purple }}

  # If the PR author has indicated that they used AI to assist coding in this PR, apply a label indicating this
  # Based on https://docs.gitstream.cm/integrations/linearb/#track-the-impact-of-generative-ai-initiatives
  label_ai_pr_jetbrains:
    if:
      - {{ pr.comments | filter(attr='commenter', term='gitstream-cm') | filter(attr='content', regex=r/\- \[x\] ChatGPT/) | some }}
    run:
      - action: add-labels@v1
        args:
          labels: ['🤖 ai-assisted', '🤖 ai-chatgpt']
          color: {{ colors.purple }}

  # If the PR author has indicated that they used AI to assist coding in this PR, apply a label indicating this
  # Based on https://docs.gitstream.cm/integrations/linearb/#track-the-impact-of-generative-ai-initiatives
  label_ai_pr_other:
    if:
      - {{ pr.comments | filter(attr='commenter', term='gitstream-cm') | filter(attr='content', regex=r/\- \[x\] Other/) | some }}
    run:
      - action: add-labels@v1
        args:
          labels: ['🤖 ai-assisted', '🤖 ai-other']
          color: {{ colors.purple }}

# The next function calculates the estimated time to review and makes it available in the automation above.
calc:
  etr: {{ branch | estimatedReviewTime }}

has:
  jira_ticket_in_title: {{ pr.title | includes(regex=r/\b[A-Za-z]+-\d+\b/) }}
  jira_ticket_in_desc: {{ pr.description | includes(regex=r/atlassian.net\/browse\/\w{1,}-\d{3,4}/) }}
  deleted_files: {{ source.diff.files | map(attr='new_file') | match(term='/dev/null') | some }}

# These are all of the colors in GitHub's default label color palette.
colors:
  red: 'b60205'
  orange: 'd93f0b'
  yellow: 'fbca04'
  green: '0e8a16'
  blue: '1d76db'
  purple: '5319e7'

size:
  is:
    small: {{ branch.diff.size < 20 }}
    medium: {{ branch.diff.size >= 20 and branch.diff.size < 100 }}
    large: {{ branch.diff.size >= 100 }}
